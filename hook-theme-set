#!/bin/bash

# Omarchy Theme Manager - Auto-tracking Hook
# Automatically updates the manifest when themes are changed
# Place this in ~/.config/omarchy/hooks/theme-set

MANAGER_DIR="$HOME/omarchy-theme-manager"
MANIFEST_FILE="$MANAGER_DIR/manifest.json"

THEME_NAME="$1"

if [ -z "$THEME_NAME" ]; then
    exit 0
fi

# Check if manifest exists
if [ ! -f "$MANIFEST_FILE" ]; then
    exit 0
fi

# Check if jq is available
if ! command -v jq &> /dev/null; then
    exit 0
fi

# Update last_active_date for the theme
timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# Update the theme's last_active_date
jq --arg name "$THEME_NAME" --arg date "$timestamp" \
    '(.themes[] | select(.name == $name) | .last_active_date) = $date | .last_updated = $date' \
    "$MANIFEST_FILE" > "$MANIFEST_FILE.tmp" && mv "$MANIFEST_FILE.tmp" "$MANIFEST_FILE"

# Check if theme exists in manifest, if not add it
if ! jq -e --arg name "$THEME_NAME" '.themes[] | select(.name == $name)' "$MANIFEST_FILE" > /dev/null 2>&1; then
    # Determine theme type
    USER_THEMES_DIR="$HOME/.config/omarchy/themes"
    STOCK_THEMES_DIR="$HOME/.local/share/omarchy/themes"
    
    if [ -d "$USER_THEMES_DIR/$THEME_NAME" ]; then
        theme_type="custom"
        theme_source="git"
        
        # Try to get git URL
        source_url="null"
        if [ -d "$USER_THEMES_DIR/$THEME_NAME/.git" ]; then
            git_url=$(cd "$USER_THEMES_DIR/$THEME_NAME" && git remote get-url origin 2>/dev/null || echo "")
            if [ -n "$git_url" ]; then
                source_url="\"$git_url\""
            fi
        fi
        display_name=$(echo "$THEME_NAME" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')
        
        new_theme=$(cat << EOF
{
  "name": "$THEME_NAME",
  "display_name": "$display_name",
  "type": "$theme_type",
  "source": "$theme_source",
  "source_url": $source_url,
  "status": "installed",
  "installed_date": "$timestamp",
  "removed_date": null,
  "last_active_date": "$timestamp"
}
EOF
)
        
        jq --argjson theme "$new_theme" '.themes += [$theme] | .last_updated = $date' "$MANIFEST_FILE" > "$MANIFEST_FILE.tmp" && mv "$MANIFEST_FILE.tmp" "$MANIFEST_FILE"
    fi
fi
