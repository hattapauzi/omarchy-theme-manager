#!/bin/bash

# Omarchy Themes Sync Script
# Synchronizes the theme manifest with the actual filesystem

set -e

MANAGER_DIR="$HOME/omarchy-theme-manager"
MANIFEST_FILE="$MANAGER_DIR/manifest.json"
USER_THEMES_DIR="$HOME/.config/omarchy/themes"
STOCK_THEMES_DIR="$HOME/.local/share/omarchy/themes"

# Check if gum is available
if ! command -v gum &> /dev/null; then
    echo "Error: 'gum' is not installed."
    exit 1
fi

# Check if manifest exists
if [ ! -f "$MANIFEST_FILE" ]; then
    gum style --foreground 196 "âŒ No manifest found. Run 'omarchy-theme-manager' first to initialize."
    exit 1
fi

# Welcome
gum style --border double --margin "1" --padding "1 2" --foreground 212 \
    "ðŸ”„ Sync Themes with System"

gum style --foreground 250 "Scanning system for changes..."

changes_made=false
new_themes=()
missing_themes=()
timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# 1. Find themes in filesystem not in manifest (new themes)
while IFS= read -r theme_dir; do
    if [ -d "$theme_dir" ]; then
        theme_name=$(basename "$theme_dir")
        
        # Check if in manifest
        if ! jq -e --arg name "$theme_name" '.themes[] | select(.name == $name)' "$MANIFEST_FILE" > /dev/null 2>&1; then
            new_themes+=("$theme_name")
        fi
    fi
done < <(find "$USER_THEMES_DIR" -mindepth 1 -maxdepth 1 -type d 2>/dev/null)

# 2. Find themes marked installed but missing from filesystem
while IFS= read -r theme_name; do
    if [ -n "$theme_name" ] && [ ! -d "$USER_THEMES_DIR/$theme_name" ]; then
        missing_themes+=("$theme_name")
    fi
done < <(jq -r '.themes[] | select(.status == "installed" and .type == "custom") | .name' "$MANIFEST_FILE")

# Show findings
gum style --margin "1" --border normal --padding "1" \
    "$(gum style --bold "ðŸ“Š Scan Results:")" \
    "   New themes found: ${#new_themes[@]}" \
    "   Missing themes: ${#missing_themes[@]}"

# Handle new themes
if [ ${#new_themes[@]} -gt 0 ]; then
    gum style --margin "1" --foreground 39 "ðŸ“¦ New themes detected:"
    
    for theme_name in "${new_themes[@]}"; do
        theme_dir="$USER_THEMES_DIR/$theme_name"
        display_name=$(echo "$theme_name" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')
        
        # Try to get git URL
        source_url="null"
        if [ -d "$theme_dir/.git" ]; then
            git_url=$(cd "$theme_dir" && git remote get-url origin 2>/dev/null || echo "")
            if [ -n "$git_url" ]; then
                source_url="\"$git_url\""
            fi
        fi
        
        gum style --foreground 250 "  â€¢ $display_name"
        
        # Add to manifest
        new_theme=$(cat << EOF
{
  "name": "$theme_name",
  "display_name": "$display_name",
  "type": "custom",
  "source": "git",
  "source_url": $source_url,
  "status": "installed",
  "installed_date": "$timestamp",
  "removed_date": null,
  "last_active_date": null
}
EOF
)
        
        jq --argjson theme "$new_theme" '.themes += [$theme]' "$MANIFEST_FILE" > "$MANIFEST_FILE.tmp"
        mv "$MANIFEST_FILE.tmp" "$MANIFEST_FILE"
        changes_made=true
    done
    
    gum style --foreground 82 "âœ… Added ${#new_themes[@]} new themes to manifest"
fi

# Handle missing themes
if [ ${#missing_themes[@]} -gt 0 ]; then
    gum style --margin "1" --foreground 208 "ðŸ—‘ï¸  Missing themes (files deleted):"
    
    for theme_name in "${missing_themes[@]}"; do
        display_name=$(jq -r --arg name "$theme_name" '.themes[] | select(.name == $name) | .display_name' "$MANIFEST_FILE")
        gum style --foreground 250 "  â€¢ $display_name"
        
        # Update status to missing
        jq --arg name "$theme_name" --arg date "$timestamp" \
            '(.themes[] | select(.name == $name) | .status) = "missing" | .last_updated = $date' \
            "$MANIFEST_FILE" > "$MANIFEST_FILE.tmp"
        mv "$MANIFEST_FILE.tmp" "$MANIFEST_FILE"
        changes_made=true
    done
    
    gum style --foreground 82 "âœ… Marked ${#missing_themes[@]} themes as missing"
fi

# Update last_updated if changes were made
if [ "$changes_made" = true ]; then
    jq --arg date "$timestamp" '.last_updated = $date' "$MANIFEST_FILE" > "$MANIFEST_FILE.tmp"
    mv "$MANIFEST_FILE.tmp" "$MANIFEST_FILE"
fi

# Summary
gum style --margin "1" --border double --padding "1 2" \
    "$(gum style --bold "âœ… Sync Complete")" \
    "" \
    "New themes added: ${#new_themes[@]}" \
    "Missing themes marked: ${#missing_themes[@]}" \
    "Last updated: $timestamp"

# Show current stats
total=$(jq '.themes | length' "$MANIFEST_FILE")
installed=$(jq '[.themes[] | select(.status == "installed")] | length' "$MANIFEST_FILE")
stock=$(jq '[.themes[] | select(.type == "stock")] | length' "$MANIFEST_FILE")
custom=$(jq '[.themes[] | select(.type == "custom")] | length' "$MANIFEST_FILE")

gum style --margin "1" \
    "$(gum style --bold "ðŸ“ˆ Current State:")" \
    "   Total: $total themes" \
    "   Installed: $installed" \
    "   Stock: $stock | Custom: $custom"
